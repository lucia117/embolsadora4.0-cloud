# ADR-004 – Ingesta HTTP Batch con idempotencia y rate-limit

**ID:** ADR-004  
**Estado:** Accepted  
**Fecha:** 2025-10-17

---

## Contexto

Las máquinas Edge pueden operar sin conexión y reenviar datos acumulados.  
El backend debe tolerar reintentos (at-least-once) sin duplicar registros (exactly-once lógico).  
También debe controlar picos de tráfico.

---

## Decisión

- **Protocolo:** HTTP batch en `/api/v1/consumers/events`.
- **Límites MVP:**
  - Hasta **1000 eventos** por batch.
  - Tamaño máximo **2 MB**.
  - Timeout de request: **2–3 segundos**.
- **Idempotencia:**
  - Por item → campo `eventId` único global.
  - Por batch (opcional) → header `Idempotency-Key` (TTL 10 min).
- **Rate-limit:** token bucket por API Key (burst 1000, 200 rps sostenidos).
- **Orden:** no garantizado entre batches; reconstrucción vía `seq` + `ts`.

---

## Alternativas consideradas

1. **Broker (Kafka / MQTT)** desde el inicio → innecesario hasta validar carga.
2. **HTTP un evento por request** → overhead de red alto, descartado.

---

## Consecuencias

- Simplicidad para el Edge y mínima configuración inicial.
- Evita duplicados por reintentos y controla saturación del sistema.
- Escalable a broker si crece el volumen de telemetría.
