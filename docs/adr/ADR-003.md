# ADR-003 – Almacenamiento de eventos en Postgres (JSONB + particionado) con retención

**ID:** ADR-003  
**Estado:** Accepted  
**Fecha:** 2025-10-17

---

## Contexto

Las máquinas envían eventos con payloads heterogéneos y de alto volumen.  
Se requiere almacenamiento confiable, consultas rápidas por tenant y ventana de tiempo, e idempotencia.

Era necesario balancear simplicidad inicial con capacidad de evolución hacia un esquema de series temporales.

---

## Decisión

- Se usa **PostgreSQL 16** como store principal.
- Tabla `machine_events` con columnas:
(tenant_id, machine_id, event_id PK, ts, seq, kind, payload JSONB)
- Índices:
- `(tenant_id, ts DESC)`
- `(machine_id, ts DESC)`
- Unique `event_id` para idempotencia.
- **Particionado mensual por rango en `ts`**.
- **Retención on-line: 90 días.**
- **Export a frío** (S3 / Cloud Storage / DWH) planificado para fases posteriores.

---

## Alternativas consideradas

1. **TimescaleDB o InfluxDB** desde el inicio → excesivo para MVP, incrementa mantenimiento.  
2. **Almacenar eventos en BigQuery directamente** → latencias de escritura demasiado altas para ingesta real-time.

---

## Consecuencias

- Simplicidad operativa y compatibilidad con ORM/sqlc.  
- Costo predecible; performance adecuada para el volumen inicial.  
- Mantenimiento periódico de particiones y limpieza (cron/worker).  
- Futura evolución natural a TimescaleDB o Kafka→DWH si crece el throughput.
