# ADR-002 – Identidad de tenant vía artefactos autenticados (JWT y API Key)

**ID:** ADR-002  
**Estado:** Accepted  
**Fecha:** 2025-10-17

---

## Contexto

El sistema es **multi-tenant**: cada empresa (tenant) tiene sus propios usuarios y máquinas.  
Debe garantizarse el aislamiento de datos incluso en entornos compartidos.  
Se analizaron distintas formas de identificar el tenant: encabezados HTTP, path variables, claims o API keys.

---

## Decisión

- **ABM (/api/v1/)**

  - El `tenant_id` se toma **exclusivamente** del **claim `tenant_id`** dentro del **JWT**.
  - Cualquier header `X-Tenant-Id` recibido será ignorado para evitar spoofing.

- **Consumers (/api/v1/consumers/)**

  - El `tenant_id` se resuelve mediante el **API Key** (lookup hash→tenant).
  - Se ignora cualquier header `X-Tenant-Id`.

- **Act-as (solo soporte o plataforma):**

  - Header `X-Act-As-Tenant` permitido únicamente si el JWT tiene rol `platform_admin`.
  - Toda acción act-as se audita.

- **Repositorios:**
  - Requieren `tenant_id` en `context.Context`; si falta, devuelven `ErrForbidden`.

---

## Alternativas consideradas

1. Permitir `X-Tenant-Id` manual → **Rechazado** (riesgo de suplantación).
2. Codificar tenant en path (`/api/v1/{tenant}/...`) → útil para debugging, pero redundante.

---

## Consecuencias

- Aislamiento fuerte y verificable por tests.
- Auditoría clara de acciones multi-tenant.
- Se impone disciplina en repos y servicios para siempre propagar el `tenant_id`.
- Simplifica el escalamiento y la futura federación de datos.
